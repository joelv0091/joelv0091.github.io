<!doctype html>
<html>
<head>
    <title>回放Demo</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Cache-Control" content="no-cache, must-revalidate" />
    <meta http-equiv="Expires" content="0" />
</head>
<style>
html, body {
    padding: 0;
    margin: 0;
}
.playWnd {
    margin: 50px 0 0 100px;
    width: 600px;
    height: 400px;
    border: 1px solid red;
}
.cbInfoDiv {
    float: left;
    width: 500px;
    margin-left: 16px;
    border:1px solid #7F9DB9;
}
.cbInfo {
    height: 200px;
    padding: 5px;
    border: 1px solid #7F9DB9;
    overflow: auto;
    word-break: break-all;
}
.operate {
    margin-top: 24px;
}
.operate::after {
    content: '';
    display: block;
    clear: both;
}
.operate .btns {
    height: 32px;
}
.module {
    float: left;
    width: 380px;
    min-height: 320px;
    margin-left: 16px;
    padding: 16px 8px;
    box-sizing: border-box;
    border: 1px solid #e5e5e5;
}
.module .item {
    margin-bottom: 4px;
}
.module .label {
    width: 150px;
    display: inline-block;
    vertical-align: middle;
    margin-right: 8px;
    text-align: right;
}
.module input[type="text"],
.module select {
    box-sizing: border-box;
    display: inline-block;
    vertical-align: middle;
    margin-left: 0;
    width: 190px;
    min-height: 20px;
}
.module .btn {
    min-width: 80px;
    min-height: 24px;
    margin-top: 16px;
    margin-left: 158px;
}
</style>
<body>
    <div id="playWnd" class="playWnd"></div>
    <div id="operate" class="operate">
        <div class="module">
            <div class="item"><span class="label">appkey:</span><input id="appkey" type="text" value="test" value="20680774" disabled></div>
            <div class="item"><span class="label">secret:</span><input id="secret" type="text" value="6o1X8WXEzCuVXlYS5ldo" disabled></div>
            <div class="item"><span class="label">API Gateway IP Address:</span><input id="ip" type="text" value="10.41.7.219"></div>
            <div class="item"><span class="label">API Gateway Port:</span><input id="port" type="text" value="80"></div>
            <div class="item"><span class="label">Capture Picture Saving Path:</span><input id="snapDir" type="text" value="" disabled></div>
            <div class="item">
                <span class="label">Initialize Layout:</span>
                <select id="layout" value="2x2">
                    <option value="1x1">1x1</option>
                    <option value="2x2" selected>2x2</option>
                    <option value="3x3">3x3</option>
                    <option value="4x4">4x4</option>
                </select>
            </div>
            <div class="item">
                <span class="label">Encrypted Field:</span>
                <div style="display: inline-block; vertical-align: top;">
                    <label><input type="checkbox" value="secret" disabled checked>secret</label><br>
                    <label><input class="encryptedFields" type="checkbox" value="appkey">appkey</label><br>
                    <label><input class="encryptedFields" type="checkbox" value="ip">ip</label><br>
                    <label><input class="encryptedFields" type="checkbox" value="snapDir">Capture Picture Path</label><br>
                    <label><input class="encryptedFields" type="checkbox" value="layout">Layout</label>
                </div>
            </div>
            <div class="item"><button id="init" class="btn">Initialize</button></div>
        </div>
        <div class="module">
            <div class="item"><span class="label">Camera No.：</span><input id="cameraIndexCode" type="text" value="7648A578F61D4A0B92217EF4062BDE04"></div>
            <div class="item"><span class="label">Playback Start Time：</span><input id="startTimeStamp" type="text" placeholder="yyyy-MM-dd hh:mm:ss"></div>
            <div class="item"><span class="label">Playback End Time：</span><input id="endTimeStamp" type="text" placeholder="yyyy-MM-dd hh:mm:ss"></div>
            <div class="item">
                <span class="label">Video Storage Location：</span>
                <select id="recordLocation" value="0">
                    <option value="0">Central Storage</option>
                    <option value="1">Device Storage</option>
                </select>
            </div>
            <div class="item">
                <span class="label">Transfer Protocol：</span>
                <select id="transMode" value="1" disabled>
                    <option value="1">TCP</option>
                    <option value="0">UDP</option>
                </select>
            </div>
            <div class="item">
                <span class="label">GPU Hardware Decoding：</span>
                <select id="gpuMode" value="0">
                    <option value="0">Disable</option>
                    <option value="1">Enable</option>
                </select>
            </div>
            <div class="item"><button id="startPlayback" class="btn">Playback</button></div>
            <div class="item"><button id="stopAllPlayback" class="btn">Stop All Playback</button></div>
            <div class="item"><button id="uninit" class="btn">Deinitialization</button></div>
        </div>
        <fieldset class="cbInfoDiv">
            <legend>Returned Value Information</legend>
            <div id="cbInfo" class="cbInfo"></div>
            <button id="clear">Clear</button>
        </fieldset>
    </div>
</body>
<script src="jquery-1.12.4.min.js"></script>
<script src="jsencrypt.min.js"></script>
<script src="jsWebControl-1.0.0.min.js"></script>
<script src="jsWebControl-Bridge.js"></script>
<script type="text/javascript">
    var oWebControl = null;// 插件对象
    var bIE = (!!window.ActiveXObject || 'ActiveXObject' in window);// 是否为IE浏览器
    var pubKey = '';

    var iLastCoverLeft = 0;
    var iLastCoverTop = 0;
    var iLastCoverRight = 0;
    var iLastCoverBottom = 0;
	
	var initCount = 0;

    var endTime = dateFormat(new Date(), "yyyy-MM-dd 23:59:59");
    var startTime = dateFormat(new Date(), "yyyy-MM-dd 00:00:00");

    $("#startTimeStamp").val(startTime)
    $("#endTimeStamp").val(endTime)

    // 标签关闭
    $(window).unload(function () {
        uninit();

        // 销毁
        oWebControl.JS_RequestInterface({
            funcName: "destroyWnd"
        }).then(function (oData) {
            showCBInfo(JSON.stringify(oData));
        });

        if (bIE) {
            if (oWebControl != null) {
                oWebControl.JS_Disconnect().then(function () {
                    console.log("JS_Disconnect");
                }, function () {});
            }
        } else{
            if (oWebControl != null) {
                oWebControl.JS_DestroyWnd().then(function () {
                    console.log("JS_DestroyWnd");
                }, function () {});
                oWebControl.JS_StopService("window").then(function () {
                    oWebControl.JS_Disconnect().then(function () {
                        console.log("JS_Disconnect");
                    }, function () {});
                });
            }
        }
    });

    // 窗口resize
    $(window).resize(function () {
        if (oWebControl != null) {
            oWebControl.JS_Resize(600, 400);
            setWndCover();
        }
    });

    // 滚动条scroll
    $(window).scroll(function () {
        if (oWebControl != null) {
            oWebControl.JS_Resize(600, 400);
            setWndCover();
        }
    });

    // 设置窗口遮挡
    function setWndCover() {
        var iWidth = $(window).width();
        var iHeight = $(window).height();
        var oDivRect = $("#playWnd").get(0).getBoundingClientRect();

        var iCoverLeft = (oDivRect.left < 0) ? Math.abs(oDivRect.left): 0;
        var iCoverTop = (oDivRect.top < 0) ? Math.abs(oDivRect.top): 0;
        var iCoverRight = (oDivRect.right - iWidth > 0) ? Math.round(oDivRect.right - iWidth) : 0;
        var iCoverBottom = (oDivRect.bottom - iHeight > 0) ? Math.round(oDivRect.bottom - iHeight) : 0;

        iCoverLeft = (iCoverLeft > 600) ? 600 : iCoverLeft;
        iCoverTop = (iCoverTop > 400) ? 400 : iCoverTop;
        iCoverRight = (iCoverRight > 600) ? 600 : iCoverRight;
        iCoverBottom = (iCoverBottom > 400) ? 400 : iCoverBottom;

        if (iLastCoverLeft != iCoverLeft) {
            console.log("iCoverLeft: " + iCoverLeft);
            iLastCoverLeft = iCoverLeft;
            oWebControl.JS_SetWndCover("left", iCoverLeft);
        }
        if (iLastCoverTop != iCoverTop) {
            console.log("iCoverTop: " + iCoverTop);
            iLastCoverTop = iCoverTop;
            oWebControl.JS_SetWndCover("top", iCoverTop);
        }
        if (iLastCoverRight != iCoverRight) {
            console.log("iCoverRight: " + iCoverRight);
            iLastCoverRight = iCoverRight;
            oWebControl.JS_SetWndCover("right", iCoverRight);
        }
        if (iLastCoverBottom != iCoverBottom) {
            console.log("iCoverBottom: " + iCoverBottom);
            iLastCoverBottom = iCoverBottom;
            oWebControl.JS_SetWndCover("bottom", iCoverBottom);
        }
    }
	

    // 初始化插件
	function initPlugin () {
		oWebControl = new WebControl({
			szPluginContainer: "playWnd",
            iServicePortStart: 16960,//todo:修改端口 15900
            iServicePortEnd: 16969,//todo:修改端口 15909
            szClassId:'55A7329E-FAAD-439A-87BC-75BAB3332E7C',//add
			cbConnectSuccess: function () {
				setCallbacks();

				oWebControl.JS_StartService("window", {
					//dllPath: "./VideoPluginConnect.dll"
					//dllPath: "./DllForTest-Win32.dll"
				}).then(function () {
                    //add:解决iframe嵌入后位置的校准
                    oWebControl.JS_SetDocOffset({
                      left:window.savePos ? window.savePos.left : 0,
                      top:window.savePos ? window.savePos.top : 0
                    });

                  oWebControl.JS_SetWindowAttr({
                    outerWidth: window.saveWindowAttr ? window.saveWindowAttr.outerWidth : 0,
                    innerWidth: window.saveWindowAttr ? window.saveWindowAttr.innerWidth : 0,
                    outerHeight: window.saveWindowAttr ? window.saveWindowAttr.outerHeight : 0,
                    innerHeight: window.saveWindowAttr ? window.saveWindowAttr.innerHeight : 0
                  });
                  console.log('调用JS_SetWindowAttr接口');


					oWebControl.JS_CreateWnd("playWnd", 600, 400, {
                        //add:解决跨域iframe下title的获取和修改
                        cbSetDocTitle: function (uuid) {
                          //推送消息，用于修改父窗口的title
                          var parentDomain = 'http://localhost:8099/';//父窗口的域名
                          if(window.parent){
                            window.parent.postMessage({
                              action:'changeTitle',
                              msg:'子页面通知父页面修改title',
                              info:uuid
                            }, parentDomain);
                          }
                        }
                    }).then(function () {
						console.log("JS_CreateWnd success");
                      oWebControl.JS_SetNumberOfWindows(1);

                        //add:解决跨域iframe下title的获取和修改
                        var parentDomain = 'http://localhost:8099/';//父窗口的域名
                        if(window.parent){
                          window.parent.postMessage({
                            action:'changeTitle',
                            msg:'子页面通知父页面将title改回去',
                            info:window.saveTitle
                          }, parentDomain);
                        }
					});

					//get snap dir path
                    oWebControl.JS_GetLocalConfig(true).then(
                      function(resp){
                        $('#snapDir').val(resp.capturePath||'');
                    },function(){
                        console.log('get snap dir failed.')
                    });
				}, function () {
                    alert('failed');
				});
			},
			cbConnectError: function () {
				console.log("cbConnectError");
				oWebControl = null;
				$("#playWnd").html("Plug-in does not start, is trying to start, please wait...");
				WebControl.JS_WakeUp("VideoWebPlugin://");
				initCount ++;
				if (initCount < 3) {
					setTimeout(function () {
						initPlugin();
					}, 3000)
				} else {
					$("#playWnd").html("Plug-in startup failed, please check whether the plug-in installed!");
				}
			},
			cbConnectClose: function () {
				console.log("cbConnectClose");
				oWebControl = null;
			}
		});
	}
	
    window.addEventListener('message', function(e){
      //alert(e.data.msg);
      //保存原本的title
      if(e && e.data){
        switch (e.data.action){
          case 'saveTitle':
            window.saveTitle = e.data.info;
            break;
          case 'setPosition':
            window.savePos = e.data.info;
            break;
          case 'setWindowAttr':
            window.saveWindowAttr = e.data.info;
            break;
        }
      }
    });
    
	initPlugin();

    // 获取公钥
    function getPubKey (callback) {
        oWebControl.JS_RequestInterface({
            funcName: "getRSAPubKey",
            argument: JSON.stringify({
                keyLength: 1024
            })
        }).then(function (oData) {
            console.log(oData)
            if (oData.responseMsg.data) {
                pubKey = oData.responseMsg.data
                callback()
            }
        })
    }

    // 设置窗口控制回调
    function setCallbacks() {
        oWebControl.JS_SetWindowControlCallback({
            cbIntegrationCallBack: cbIntegrationCallBack
        });
    }

    // 推送消息
    function cbIntegrationCallBack(oData) {
        showCBInfo(JSON.stringify(oData.responseMsg));
    }

    // RSA加密
    function setEncrypt (value) {
        var encrypt = new JSEncrypt();
        encrypt.setPublicKey(pubKey);
        return encrypt.encrypt(value);
    }

    // 初始化
    $("#init").click(function () {
        getPubKey(function () {
            var appkey = $("#appkey").val();
            var secret = setEncrypt($("#secret").val());
            var ip = $("#ip").val();
            var port = Number.parseInt($("#port").val());
            var snapDir = $("#snapDir").val();
            var layout = $("#layout").val();
            var encryptedFields = ['secret'];
            $(".encryptedFields").each(function (index, item) {
                var $item = $(item);
                if ($item.prop('checked')) {
                    var value = $item.val();
                    if (value !== 'secret') {
                        encryptedFields.push(value);
                    }

                    // secret固定加密，appkey和ip根据用户勾选加密
                    if (value == 'ip') {
                        ip = setEncrypt(ip)
                    }
                    if (value == 'appkey') {
                        appkey = setEncrypt(appkey)
                    }
                    if (value == 'snapDir') {
                        snapDir = setEncrypt(snapDir)
                    }
                    if (value == 'layout') {
                        layout = setEncrypt(layout)
                    }
                }
            })
            encryptedFields = encryptedFields.join(",");

            if (!appkey) {
                showCBInfo("appkey can not empty!", 'error');
                return
            }
            if (!$("#secret").val()) {
                showCBInfo("secret can not empty!", 'error');
                return
            }
            if (!ip) {
                showCBInfo("ipcan not empty!", 'error');
                return
            }
            if (!$("#port").val()) {
                showCBInfo("port can not empty!", 'error');
                return
            } else if (!/^([0-9]|[1-9]\d{1,3}|[1-5]\d{4}|6[0-5]{2}[0-3][0-5])$/.test($("#port").val())) {
                showCBInfo("invalid port number!", 'error');
                return
            }

            oWebControl.JS_RequestInterface({
                funcName: "init",
                argument: JSON.stringify({
                    appkey: appkey,
                    secret: secret,
                    ip: ip,
                    playMode: 1, // 回放
                    port: port,
                    snapDir: snapDir,
                    layout: layout,
                    encryptedFields: encryptedFields
                })
            }).then(function (oData) {
                showCBInfo(JSON.stringify(oData ? oData.responseMsg : ''));
            });
        })
    });

    // 录像回放
    $("#startPlayback").click(function () {
        var cameraIndexCode  = $("#cameraIndexCode").val();
        var startTimeStamp = new Date($("#startTimeStamp").val().replace('-', '/')).getTime();
        var endTimeStamp = new Date($("#endTimeStamp").val().replace('-', '/')).getTime();
        var recordLocation = +$("#recordLocation").val();
        var transMode = +$("#transMode").val();
        var gpuMode = +$("#gpuMode").val();

        if (!cameraIndexCode) {
            showCBInfo("Camera No. can not empty", 'error');
            return
        }

        if (Number.isNaN(+startTimeStamp) || Number.isNaN(+endTimeStamp)) {
            showCBInfo("Time format is wrong!", 'error');
            return
        }

        oWebControl.JS_RequestInterface({
            funcName: "startPlayback",
            argument: JSON.stringify({
                cameraIndexCode: cameraIndexCode,
                startTimeStamp: Math.floor(startTimeStamp / 1000),
                endTimeStamp: Math.floor(endTimeStamp / 1000),
                recordLocation: recordLocation,
                transMode: transMode,
                gpuMode: gpuMode
            })
        }).then(function (oData) {
            showCBInfo(JSON.stringify(oData ? oData.responseMsg : ''));
        });
    })
    
    // 停止回放
    $("#stopAllPlayback").click(function () {
        oWebControl.JS_RequestInterface({
            funcName: "stopAllPlayback"
        }).then(function (oData) {
            showCBInfo(JSON.stringify(oData ? oData.responseMsg : ''));
        });
    })

    // 反初始化
    function uninit () {
        oWebControl.JS_RequestInterface({
            funcName: "uninit"
        }).then(function (oData) {
            showCBInfo(JSON.stringify(oData ? oData.responseMsg : ''));
        });
    }
    $("#uninit").click(uninit)

    // 显示回调信息
    function showCBInfo(szInfo, type) {
        if (type === 'error') {
            szInfo = "<div style='color: red;'>" + dateFormat(new Date(), "yyyy-MM-dd hh:mm:ss") + " " + szInfo + "</div>";
        } else {
            szInfo = "<div>" + dateFormat(new Date(), "yyyy-MM-dd hh:mm:ss") + " " + szInfo + "</div>";
        }
        $("#cbInfo").html(szInfo + $("#cbInfo").html());
    }

    $("#clear").click(function() {
        $("#cbInfo").html('');
    })

    // 格式化时间
    function dateFormat(oDate, fmt) {
        var o = {
            "M+": oDate.getMonth() + 1, //月份
            "d+": oDate.getDate(), //日
            "h+": oDate.getHours(), //小时
            "m+": oDate.getMinutes(), //分
            "s+": oDate.getSeconds(), //秒
            "q+": Math.floor((oDate.getMonth() + 3) / 3), //季度
            "S": oDate.getMilliseconds()//毫秒
        };
        if (/(y+)/.test(fmt)) {
            fmt = fmt.replace(RegExp.$1, (oDate.getFullYear() + "").substr(4 - RegExp.$1.length));
        }
        for (var k in o) {
            if (new RegExp("(" + k + ")").test(fmt)) {
                fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
            }
        }
        return fmt;
    }


</script>
</html>