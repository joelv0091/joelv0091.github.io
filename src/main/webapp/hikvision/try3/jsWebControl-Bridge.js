!function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(r,o,function(t){return e[t]}.bind(null,o));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){n(1),e.exports=n(2)},function(e,t,n){"use strict";!function(){console.log("this is Bridge!"),window.Plugin=WebControl,window.WebControl=null;var e=function(e){var t;return this.plugin=new Plugin(e),(t=this.plugin).JS_RequestInterface=o,t.JS_StartService=s,this.plugin};e.JS_WakeUp=function(e){var t=document.createElement("iframe");t.style.display="none",t.src=e,document.body.appendChild(t),setTimeout(function(){document.body.removeChild(t)},3e3)},window.Bridge=e,window.WebControl=e;var t=function(e){this.ip=e.ip,this.wsIP=e.wsIP,this.wsPort=e.wsPort,this.preview=l,this.playback=u,this.initWS=a,this.ws=null,this.wsEvents={},this.getCameraInfo=c,this.getStorageInfo=p,this.getCommonUrl=d,this.getID=m,this.wsSend=i},n="0",r="10002";function o(e){var o=this,s=e.funcName,a=e.argument?JSON.parse(e.argument):{};switch(s){case"init":return new Promise(function(e,n){setTimeout(function(){o.bridge={appkey:a.appkey,secret:a.secret,ip:a.ip,port:a.port,snapDir:a.snapDir,layout:a.layout,encryptedFields:a.encryptedFields,playMode:a.playMode},o.play&&o.play.ws&&o.play.ws.close(),o.play=new t({ip:a.ip,port:a.port,wsIP:a.ip,wsPort:r}),1==a.playMode&&o.JS_ChangePlayMode(1),o.JS_SetNumberOfWindows(function(e){switch(e){case"1x1":return 1;case"2x2":return 4;case"3x3":return 9;case"4x4":return 16;default:return 4}}(a.layout));var n="http://"+a.ip+":"+a.port+"/locales/en/plugin.json";o.JS_SetLanguageType("en"),o.JS_SetTranslateFile(n),o.play.initWS().then(function(){e({responseMsg:{code:"0"}})},function(t){e({responseMsg:{code:"Initialize the websocket failure."+t||!1}})})})});case"uninit":return o.play&&o.play.ws&&o.play.ws.close(),delete o.bridge,delete o.play,new Promise(function(e,t){setTimeout(function(){o.JS_StopTotal().then(function(t){setTimeout(function(){e({responseMsg:{code:"0"}})})},function(t){setTimeout(function(t){e({responseMsg:{code:t}})})})})});case"destroyWnd":return new Promise(function(e,t){o.JS_Disconnect(),setTimeout(function(){e({responseMsg:{data:"destroyWnd success"}})})});case"getRSAPubKey":return new Promise(function(e,t){setTimeout(function(){e({responseMsg:{data:n}})})});case"startPreview":return new Promise(function(e,t){o.play||e({responseMsg:{code:"To initialize the plug-in"}});var n={enableGPU:parseInt(a.gpuMode,10)};o.JS_SetLocalConfig(n).then(function(){console.log("set gpu decoder success")}),new Promise(function(e,t){o.play.ws?e():o.play.initWS().then(function(){e()},function(){t()})}).then(function(){o.play.getID(a.cameraIndexCode,{success:function(t){console.log(t),o.play.getCameraInfo(t.element_id,{success:function(t){var n=t.CameraElement;console.log(n);var r=n.Encoder,s="null",i="null",l="null",u="null";r&&(s=r.Type||"0",i=r.URLFormat||"null",l=r.Address||"null",u=r.Port||"null"),o.play.preview({siteId:n.SiteID,linkType:"0",id:n.ID,cameraId:n.Camera.ID,adaption:n.Camera.Adaption,permission:n.Permission,abilitySet:n.AbilitySet,cameraType:n.Camera.Type,encoderType:s,smsType:i,deviceIp:l,devicePort:u,channelNo:n.Camera.No,streamType:a.streamMode||n.StreamType,enableVoice:!0,onPlay:function(t,r,s,a,i){var l={secretKey:i,multiStreamProto:parseInt(n.Camera.MultiStreamProto)};o.JS_Play(t,r,s,n.SiteID,n.AreaName,n.Name,a,-1,l),o.JS_SetWindowControlCallback({cbGotoPlayback:function(t,r){console.log("cbGotoPlayback"),o.play.playback(n.ID,0).then(function(t){var n=t.camera,r={secretKey:t.streamSecretKey,dualStream:parseInt(n.DoubleStream)};o.JS_SetVsmToken(t.smsToken),o.JS_Play(t.url,t.user,t.pwd,"0",n.AreaName,n.Name,t.perXml,-1,r),e({responseMsg:{code:"0"}})},function(t){e({responseMsg:{code:t}})})}}),e({responseMsg:"preview success"})},onSetToken:function(e){o.JS_SetVsmToken(e)}})},error:function(t){e(t||"preview error")}})},error:function(t){e({responseMsg:{error:"preview error"}})}})})});case"stopAllPreview":return new Promise(function(e,t){o.JS_StopTotal().then(function(){e({responseMsg:{msg:"stopAllPreview success"}})},function(){e({responseMsg:{error:"stopAllPreview failed"}})})});case"startPlayback":var i="/startTime:"+g(a.startTimeStamp)+"/endTime:"+g(a.endTimeStamp);return new Promise(function(e,t){o.play||e({responseMsg:{code:"To initialize the plug-in"}}),o.JS_GetLocalConfig(1).then(function(e){console.log("capture path:"+e.capturePath)});var n={enableGPU:parseInt(a.gpuMode,10)};o.JS_SetLocalConfig(n).then(function(){console.log("set gpu decoder success")}),new Promise(function(e,t){o.play.ws?e():o.play.initWS().then(function(){e()},function(){t()})}).then(function(){o.play.getID(a.cameraIndexCode,{success:function(t){var n=t.element_id;o.play.playback(n,a.recordLocation).then(function(t){var n=t.camera,r={secretKey:t.streamSecretKey,dualStream:parseInt(n.DoubleStream)};o.JS_SetVsmToken(t.smsToken),o.JS_Play(t.url+i,t.user,t.pwd,"0",n.AreaName,n.Name,t.perXml,-1,r),e({responseMsg:{code:"0"}})},function(t){e({responseMsg:{code:t}})})},error:function(t){e({responseMsg:{code:"Request parameter error:"+t}})}})})});case"stopAllPlayback":return new Promise(function(e,t){o.JS_StopTotal().then(function(t){setTimeout(function(){e({responseMsg:{code:"0"}})})},function(t){setTimeout(function(t){e({responseMsg:{code:t}})})})});default:return new Promise(function(e,t){setTimeout(function(){e({responseMsg:{code:"0"}})})})}}function s(e,t){return new Promise(function(e,t){setTimeout(function(){e()})})}function a(){var e=this;return new Promise(function(t,n){var r="ws://"+e.wsIP+":"+e.wsPort,o=null;try{3===(o=new WebSocket(r)).readyState?n("init failed, webSocket connect failed."):(o.onclose=function(t){e.ws=null},o.onerror=function(t){e.ws=null,n("")},o.onopen=function(){e.ws=o,t()},o.onmessage=function(t){if(t&&t.data){var n=h(function(e){if(document.all){var t=new ActiveXObject("Microsoft.XMLDOM");return t.async=!1,t.loadXML(e),t}return(new DOMParser).parseFromString(e,"text/xml")}(t.data));n&&n.Msg&&n.Msg.uuid&&e.wsEvents[n.Msg.uuid]&&(n.Msg.ResponseStatus&&n.Msg.ResponseStatus.Data?e.wsEvents[n.Msg.uuid].success.call(this,n.Msg.ResponseStatus.Data):e.wsEvents[n.Msg.uuid].error.call(this,n.Msg.ResponseStatus.Error),delete e.wsEvents[t.uuid])}})}catch(e){setTimeout(function(){n(e.message)})}})}function i(e){var t=this;t.ws&&t.ws.send?t.ws.send(e):t.initWS().then(function(){t.wsSend(e)})}function l(e){var t=this,n=$.extend({},{siteId:"0",linkType:"0",id:"0",cameraId:"0",adaption:null,permission:null,abilitySet:"",cameraType:"0",encoderType:"0",smsType:"null",deviceIp:"null",devicePort:"null",channelNo:"",streamType:"0",enableVoice:!1,onPlay:null,onSetToken:null,onURLErrorRes:null,onVoiceErrorRes:null,onError:null},e),r="";n.permission&&(r=b(n.permission));var o,s=n.adaption?n.adaption.StreamType:0,a=T(n.abilitySet);o={CommonUrlRequest:{requestType:1,cameraElementID:n.id,extraType:n.streamType,adaptiveNetWork:n.linkType}},t.getCommonUrl(o,{success:function(e){var o=e.commonUrl1;if(o){var i=S(o.url,o.SMSWebSocketPort),l=o.UserName,u=o.PassWord,c=o.StreamSecretKey?o.StreamSecretKey:"";switch(i.prefix){case"[sms:preview]":var p="";o.SMSToken&&"1"==o.SMSToken.Enable&&(p=o.SMSToken.Token);var d=n.onSetToken;d&&"function"==typeof d&&d.call(this,p);var m="",g=$.Deferred();if(n.enableVoice){var f={CommonUrlRequest:{requestType:3,cameraElementID:n.id,extraType:0,adaptiveNetWork:n.linkType}};t.getCommonUrl(f,{success:function(e){var t=S(e.commonUrl1.url);m=t.url,g.resolve()},error:function(e){}})}else g.resolve();g.then(function(){var e=n.onPlay;if(e&&"function"==typeof e){var t,o=n.smsType+"://"+n.deviceIp+"/"+n.devicePort+"/"+n.channelNo+"/"+n.streamType+"/"+n.cameraId+"/"+n.id+"/"+n.encoderType+"/"+n.cameraType+"/"+a+"/"+s;t=i.prefix+o+"@"+i.url+"@"+m,console.log(t),e.call(this,t,l,u,r,c)}});break;case"[sdk:preview]":var h=i.url.replace(/:/g,"/"),y=i.prefix+h+"/"+n.cameraId+"/"+n.id+"/"+n.encoderType+"/"+n.cameraType+"/"+a+"/"+s;console.log(y);var T=n.onPlay;T&&"function"==typeof T&&T.call(this,y,l,u,r,c)}}},error:function(e){}})}function u(e,t){var n=this;return new Promise(function(r,o){n.getCameraInfo(e,{success:function(e){var s=e.CameraElement,a=s.ID,i=s.Camera.ID,l=s.RecordingSettingList.RecordingSetting,u=[],c=T(s.AbilitySet),p=s.streamType,d=s.adaption?s.adaption.IsSupportPlayBack:0,m=function(e){var t="0";e&&"6"==e.DeviceClass&&(t="1");return t}(s.Encoder),g=b(s.Permission),f=s.AreaName,h=s.Name,y=s.Camera.DoubleStream;if(l){var v={},w={},P=l;"1"==P.EnableMainStorage&&(v="1"==P.MainStorage.EnableRecordPassback?P.MainStorage.RecordPassbackParam:P.MainStorage.RecordSettingParam,u.push({storageType:v.StorageLocationType,storageMediaID:v.RecordServerID,streamType:v.RecordingStreamType||"0"})),"1"==P.EnableAuxStorage&&(w="1"==P.AuxStorage.EnableRecordPassback?P.AuxStorage.RecordPassbackParam:P.AuxStorage.RecordSettingParam,u.push({storageType:w.StorageLocationType,storageMediaID:w.RecordServerID,streamType:w.RecordingStreamType||"0"}))}var E=[];if(u.map(function(e,n){"1"==t?e&&"2"==e.storageType&&E.push(e):e&&"2"!=e.storageType&&E.push(e)}),0!=E.length){p=E[0].streamType||"0";var M={CommonUrlRequest:{requestType:2,cameraElementID:a,extraType:E[0].storageType,extraID:E[0].storageMediaID,adaptiveNetWork:0}};n.getCommonUrl(M,{success:function(e){var t=e.commonUrl1,o=S(t.url),s=t.UserName,l=t.PassWord,u=t.StreamSecretKey,T={StorageInfoRequest:{cameraElementID:a,storageMediaType:E[0].storageType,storageMediaID:E[0].storageMediaID,adaptiveNetWork:0}};n.getStorageInfo(T,{success:function(e){var n=e.StorageInfo,a=n.storageAddress,S=n.storagePort,T=n.storageChannelNo||"null",b=n.storageType,v=n.searchType,w=n.storageStreamID||"null",P=n.accessPath||"null",E=n.accessType,M=a+"/"+S+"/"+i+"/"+T+"/"+b+"/"+v+"/"+w+"/"+P+"/"+E+"/"+c+"/"+p+"/"+d+"/"+m,I="";switch(o.prefix){case"[sms:playback]":var k="";t.SMSToken&&"1"==t.SMSToken.Enable&&(k=t.SMSToken.Token),I=o.prefix+M+"@"+o.url;break;case"[sdk:playback]":I=o.prefix+M}r({smsToken:k,url:I,user:s,pwd:l,perXml:g,streamSecretKey:u,camera:{AreaName:f,Name:h,DoubleStream:y}})},error:function(e){r({responseMsg:{code:"Request parameter error:"+e}})}})},error:function(e){r({responseMsg:{code:"Request parameter error:"+e}})}})}else o("0"==t?"no record setting for center":"no record setting for local")},error:function(e){r({responseMsg:{code:"Request parameter error:"+e}})}})})}function c(e,t){var n="camera-"+Date.parse(new Date),r=f({Msg:{ProtocolType:1,LinkMark:"",MsgType:21,uuid:n,url:new String("/ISAPI/Bumblebee/CameraElements/{ID}").toString().replace("{ID}",e),request:"",method:"POSTGET"}});this.wsSend(r),this.wsEvents[n]=t}function p(e,t){var n="storage-"+Date.parse(new Date),r=f({Msg:{ProtocolType:1,LinkMark:"",MsgType:21,uuid:n,url:"/ISAPI/Bumblebee/StorageInfo",request:e,method:"POSTGET"}});this.wsSend(r),this.wsEvents[n]=t}function d(e,t){var n="commonUrl-"+Date.parse(new Date),r=f({Msg:{ProtocolType:1,LinkMark:e.linkType,MsgType:21,uuid:n,url:"/ISAPI/Bumblebee/CommonUrl",request:e,method:"POSTGET",apiIp:this.ip}});this.wsSend(r),this.wsEvents[n]=t}function m(e,t){var n="serial-"+Date.parse(new Date),r=f({Msg:{ProtocolType:1,url:"/ISAPI/Bumblebee/GetCameraID",MsgType:21,uuid:n,LinkMark:"",serialnumber:e,method:"POSTGET"}});this.wsSend(r),this.wsEvents[n]=t}function g(e){var t=new Date(1e3*parseInt(e)),n=1900+t.getYear(),r="0"+(t.getMonth()+1),o="0"+t.getDate(),s="0"+t.getHours(),a="0"+t.getMinutes(),i="0"+t.getSeconds();return n+"-"+r.substring(r.length-2,r.length)+"-"+o.substring(o.length-2,o.length)+"T"+s.substring(s.length-2,s.length)+":"+a.substring(a.length-2,a.length)+":"+i.substring(i.length-2,i.length)+"Z"}function f(e){return new JsonToXml(!0).toXml(e)}function h(e,t){if(!e)return null;var n=null;if(3==e.nodeType)n=e.nodeValue;else if(1==e.nodeType)if(2==t)if(e.attributes.length||e.childNodes.length){if(n={},e.attributes.length>0){n["@attrs"]={};for(var r=e.attributes.length,o=0;o<r;o++){var s=e.attributes.item(o);n["@attrs"][s.nodeName]=s.nodeValue}}n=y(n,e,t)}else n="";else n=e.childNodes.length?y(n={},e,t):"";else 9==e.nodeType&&y(n={},e,t);return n}var y=function(e,t,n){if(t.hasChildNodes()){var r,o=t.childNodes.length;try{r=t.childNodes[0].nodeName}catch(e){}for(var s=0;s<o;s++){var a=t.childNodes.item(s),i=a.nodeName;if(void 0===e[i])if(3==a.nodeType){if("\n"!==a.nodeValue){if("#text"!=r){e=a.nodeValue;break}return 2==n?e["@value"]=null==t.textContent?t.text:t.textContent:e=null==t.textContent?t.text:t.textContent,e}}else e[i]=h(a,n);else{if(!Array.isArray(e[i])){var l=e[i];e[i]=[],e[i].push(l)}e[i].push(h(a,n))}}}return e};function S(e,t){var n=e,r={prefix:"",url:"",password:"",name:""},o={},s={};o.prefixEnd=n.indexOf("]");var a=n.length;switch(r.prefix=n.substring(0,o.prefixEnd+1),n=n.substring(o.prefixEnd+1,a),r.prefix){case"[sms:playback]":o.End=n.indexOf("//"),s.rtsp=n.substring(0,o.End),a=n.length,n=n.substring(o.End+2,a),r.url=s.rtsp+"//"+n,console.log("obj:"+r.url);break;case"[sdk:playback]":case"[sdk:voicetalk]":o.End=n.indexOf("/"),a=n.length,s.ip=n.substring(0,o.End),n=n.substring(o.End+1,a),o.End=n.indexOf("/"),a=n.length,s.port=n.substring(0,o.End),n=n.substring(o.End+1,a),s.channelNo=n,r.url=s.ip+"/"+s.port+"/"+s.channelNo,console.log("obj:"+r.url);break;case"[sms:preview]":case"[sms:voicetalk]":o.End=n.indexOf("//"),a=n.length,s.rtsp=n.substring(0,o.End),n=n.substring(o.End+2,a),o.End=n.indexOf(":"),a=n.length,s.streamIp=n.substring(0,o.End),n=n.substring(o.End+1,a),o.End=n.indexOf("/"),a=n.length,s.streamPort=n.substring(0,o.End),n=n.substring(o.End+1,a),o.End=n.indexOf("//"),a=n.length,s.type=n.substring(0,o.End),n=n.substring(o.End+2,a),o.End=n.indexOf(":"),a=n.length,s.ip=n.substring(0,o.End),n=n.substring(o.End+1,a),o.End=n.indexOf(":"),a=n.length,s.port=n.substring(0,o.End),n=n.substring(o.End+1,a),o.End=n.indexOf(":"),a=n.length,s.channelNo=n.substring(0,o.End),n=n.substring(o.End+1,a),s.streamType=n,r.playUrl=s.type+"//"+s.ip+":"+s.port+":"+s.channelNo+":"+s.streamType,t&&(r.smsUrl=s.streamIp+":"+t+"/"+s.channelNo+s.streamType),r.url=s.rtsp+"//"+s.streamIp+":"+s.streamPort+"/"+s.type+"//"+s.ip+":"+s.port+":"+s.channelNo+":"+s.streamType,console.log("obj:"+r.url);break;case"[sdk:preview]":o.End=n.indexOf("/"),a=n.length,s.ip=n.substring(0,o.End),n=n.substring(o.End+1,a),o.End=n.indexOf("/"),a=n.length,s.port=n.substring(0,o.End),n=n.substring(o.End+1,a),o.End=n.indexOf(":"),a=n.length,s.channelNo=n.substring(0,o.End),n=n.substring(o.End+1,a),o.End=n.indexOf(":"),a=n.length,s.streamType=n.substring(0,o.End),n=n.substring(o.End+1,a),s.linkType=n,r.url=s.ip+"/"+s.port+"/"+s.channelNo+":"+s.streamType+":"+s.linkType,console.log("obj:"+r.url)}return r}function T(e){var t="0";return e&&String===e.constructor&&(e=e.split(",")).indexOf("8")>-1&&(t="1"),t}function b(e){return{liveView:parseInt(e.LiveView,10),playback:parseInt(e.Playback,10),videoSearch:parseInt(e.VideoSearch,10),manualRecording:parseInt(e.ManualRecording,10),twoWayAudio:parseInt(e.TwoWayAudio,10),ptzControl:parseInt(e.PTZControl,10),capturePrint:parseInt(e.CapturePrint,10),volume:parseInt(e.VoiceControl,10)}}}()},function(e,t){window.JsonToXml=function(e,t){this.result=[],this.isPretty=!!e,this.separator=t||""},window.JsonToXml=JsonToXml,JsonToXml.prototype.spacialChars=["&","<",">",'"',"'"],JsonToXml.prototype.validChars=["&amp;","&lt;","&gt;","&quot;","&apos;"],JsonToXml.prototype.toString=function(){return this.result.join("")},JsonToXml.prototype.replaceSpecialChar=function(e){for(var t=this.spacialChars.length,n=0;n<t;n++)e=e.replace(new RegExp(this.spacialChars[n],"g"),this.validChars[n]);return e},JsonToXml.prototype.appendText=function(e){e=this.replaceSpecialChar(e),this.result.push(e)},JsonToXml.prototype.appendFlagBegin=function(e){this.result.push("<"+e+">")},JsonToXml.prototype.appendFlagEnd=function(e){this.result.push("</"+e+">"),this.isPretty&&this.result.push(this.separator)},JsonToXml.prototype.each=function(e,t){for(var n=e.length,r=0;r<n;r++)t(r,e[r])},JsonToXml.prototype.formatXml=function(e){var t=[];e=e.replace(/(>)(<)(\/*)/g,"$1"+this.separator+"$2$3");var n=0,r=this;return this.each(e.split(this.separator),function(e,o){var s=0;o.match(/.+<\/\w[^>]*>$/)?s=0:o.match(/^<\/\w/)?0!=n&&(n-=1):s=o.match(/^<\w[^>]*[^\/]>.*$/)?1:0;for(var a="",i=0;i<n;i++)a+="  ";t.push(a+o+r.separator),n+=s}),t.join("")},JsonToXml.prototype.toXml=function(e){return this._toXml(e),this.isPretty?this.formatXml(this.toString()):this.toString()},JsonToXml.prototype._toXml=function(e){for(var t in e){var n=e[t];if(null!=n)if(Array===n.constructor)for(var r=n.length,o=0;o<r;o++){this.appendFlagBegin(t);var s=n[o];if(s.constructor===Object)this._toXml(s);else if(s.constructor===Array){var a={};a[t]=s,this._toXml(a)}else s.constructor===String?this.appendText(s):Number===s.constructor?this.appendText(""+s):Boolean===s.constructor&&this.appendText(""+s);this.appendFlagEnd(t)}else this.appendFlagBegin(t),Object===n.constructor?this._toXml(n):String===n.constructor?this.appendText(n):Number===n.constructor?this.appendText(""+n):Boolean===n.constructor&&this.appendText(""+n),this.appendFlagEnd(t);else this.appendFlagBegin(t),this.appendFlagEnd(t)}}}]);