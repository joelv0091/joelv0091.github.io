<!doctype html>
<html>

<head>

<title>live view demo</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Cache-Control" content="no-cache, must-revalidate" />
<meta http-equiv="Expires" content="0" />

<link rel="stylesheet" href="../style/css/app.css">
</head>
<style>

</style>

<body>
	<div id="playWnd" class="playWnd"></div>
	<div id="operate" class="operate">
		<div class="module">
			<div class="item">
				<span class="label">appkey:</span><input id="appkey" type="text"
					disabled>
			</div>
			<div class="item">
				<span class="label">secret:</span><input id="secret" type="text"
					disabled>
			</div>
			<div class="item">
				<span class="label">API Gateway IP Address:</span><input id="ip"
					type="text">
			</div>
			<div class="item">
				<span class="label">API Gateway Port:</span><input id="port"
					type="text" value="80">
			</div>
			<div class="item">
				<span class="label">Capture Picture Saving Path:</span><input
					id="snapDir" type="text" value="D:\SnapDir" disabled>
			</div>
			<div class="item">
				<span class="label">Initialize Layout:</span> <select id="layout"
					value="2x2">
					<option value="1x1">1x1</option>
					<option value="2x2" selected>2x2</option>
					<option value="3x3">3x3</option>
					<option value="4x4">4x4</option>
				</select>
			</div>
			<div class="item">
				<span class="label">Encrypted Field:</span>
				<div
					style="display: inline-block; vertical-align: top; width: 150px;">
					<label><input type="checkbox" value="secret" disabled
						checked>secret</label><br> <label><input
						class="encryptedFields" type="checkbox" disabled value="appkey">appkey</label><br>
					<label><input class="encryptedFields" type="checkbox"
						disabled value="ip">ip</label><br> <label><input
						class="encryptedFields" type="checkbox" disabled value="snapDir">Capture
						Picture Path</label><br> <label><input
						class="encryptedFields" type="checkbox" disabled value="layout">Layout</label>
				</div>
			</div>
			<div class="item">
				<button id="init" class="btn">Initialize</button>
			</div>
		</div>
		<div class="module">
			<div class="item">
				<span class="label">Camera No：</span><input id="cameraIndexCode"
					type="text">
			</div>
			<div class="item">
				<span class="label">Main Stream/Sub-Stream ID：</span> <select
					id="streamMode" value="0">
					<option value="0">Main Stream</option>
					<option value="1">Sub-Stream</option>
				</select>
			</div>
			<div class="item">
				<span class="label">Transfer Protocol：</span> <select id="transMode"
					value="1" disabled>
					<option value="1">TCP</option>
					<option value="0">UDP</option>
				</select>
			</div>
			<div class="item">
				<span class="label">GPU Hardware Decoding：</span> <select
					id="gpuMode" value="0">
					<option value="0">Disable</option>
					<option value="1">Enable</option>
				</select>
			</div>
			<div class="item">
				<button id="startPreview" class="btn">Live View</button>
			</div>
			<div class="item">
				<button id="stopAllPreview" class="btn">Stop All Live View</button>
			</div>
			<div class="item">
				<button id="uninit" class="btn">De-initialization</button>
			</div>
		</div>
		<fieldset class="cbInfoDiv">
			<legend>Returned Value Information</legend>
			<div id="cbInfo" class="cbInfo"></div>
			<button id="clear">Clear</button>
		</fieldset>
	</div>
</body>

<script src="jquery-1.12.4.min.js"></script>
<script src="jsencrypt.min.js"></script>
<script src="jsWebControl-1.0.0.min.js"></script>
<script src="jsWebControl-Bridge.js"></script>



<script src="stream.hikvision.reverseChannel.js"></script>


<script type="text/javascript">
  var oWebControl = null; // plug-in object
  var bIE = (!!window.ActiveXObject || 'ActiveXObject' in window); // if ie browser
  var pubKey = '';

  var iLastCoverLeft = 0;
  var iLastCoverTop = 0;
  var iLastCoverRight = 0;
  var iLastCoverBottom = 0;
  var initCount = 0;

  $("#appkey").val('20680774');
  $("#secret").val('6o1X8WXEzCuVXlYS5ldo');
  $("#ip").val('192.168.1.186');
  $("#port").val(80);
  $("#cameraIndexCode").val('87E99E1002D049F38EFEE86F8C09348E');

  // label close
  $(window).unload(function () {
    uninit();

    // destroy
    oWebControl.JS_RequestInterface({
      funcName: "destroyWnd"
    }).then(function (oData) {
      showCBInfo(JSON.stringify(oData));
    });

    if (bIE) {
      if (oWebControl != null) {
        oWebControl.JS_Disconnect().then(function () {
          console.log("JS_Disconnect");
        }, function () {});
      }
    } else {
      if (oWebControl != null) {
        oWebControl.JS_DestroyWnd().then(function () {
          console.log("JS_DestroyWnd");
        }, function () {});
        oWebControl.JS_StopService("window").then(function () {
          oWebControl.JS_Disconnect().then(function () {
            console.log("JS_Disconnect");
          }, function () {});
        });
      }
    }
  });

  // window resize
  $(window).resize(function () {
    if (oWebControl != null) {
      oWebControl.JS_Resize(600, 400);
      setWndCover();
    }
  });

  // scroll
  $(window).scroll(function () {
    if (oWebControl != null) {

	 //   console.log("iCoverLeft: " + iCoverLeft);
      oWebControl.JS_Resize(600, 400);
      setWndCover();
    }
  });

  // set window cover
  function setWndCover() {
    var iWidth = $(window).width();
    var iHeight = $(window).height();
    var oDivRect = $("#playWnd").get(0).getBoundingClientRect();

    var iCoverLeft = (oDivRect.left < 0) ? Math.abs(oDivRect.left) : 0;
    var iCoverTop = (oDivRect.top < 0) ? Math.abs(oDivRect.top) : 0;
    var iCoverRight = (oDivRect.right - iWidth > 0) ? Math.round(oDivRect.right - iWidth) : 0;
    var iCoverBottom = (oDivRect.bottom - iHeight > 0) ? Math.round(oDivRect.bottom - iHeight) : 0;

    iCoverLeft = (iCoverLeft > 600) ? 600 : iCoverLeft;
    iCoverTop = (iCoverTop > 400) ? 400 : iCoverTop;
    iCoverRight = (iCoverRight > 600) ? 600 : iCoverRight;
    iCoverBottom = (iCoverBottom > 400) ? 400 : iCoverBottom;

    if (iLastCoverLeft != iCoverLeft) {
      console.log("iCoverLeft: " + iCoverLeft);
      iLastCoverLeft = iCoverLeft;
      oWebControl.JS_SetWndCover("left", iCoverLeft);
    }
    if (iLastCoverTop != iCoverTop) {
      console.log("iCoverTop: " + iCoverTop);
      iLastCoverTop = iCoverTop;
      oWebControl.JS_SetWndCover("top", iCoverTop);
    }
    if (iLastCoverRight != iCoverRight) {
      console.log("iCoverRight: " + iCoverRight);
      iLastCoverRight = iCoverRight;
      oWebControl.JS_SetWndCover("right", iCoverRight);
    }
    if (iLastCoverBottom != iCoverBottom) {
      console.log("iCoverBottom: " + iCoverBottom);
      iLastCoverBottom = iCoverBottom;
      oWebControl.JS_SetWndCover("bottom", iCoverBottom);
    }
  }
  var parentDomain = 'http://192.168.1.190:5100/';//ip of parent window
  parentDomain= ( (parent.window.location) && (typeof parent.window.location.href == 'string') ) ?  parent.window.location.href.replace(parent.window.location.pathname,'/') :"";
  // initial plug-in
  function initPlugin() {
    oWebControl = new WebControl({
      szPluginContainer: "playWnd",
      iServicePortStart: 16960,
      iServicePortEnd: 16969,
      szClassId:'55A7329E-FAAD-439A-87BC-75BAB3332E7C',//add classid to insure work well on ie
    //  cbConnectSuccess: function () {
      cbConnectSuccess: function () {
        setCallbacks();

        oWebControl.JS_StartService("window").then(function () {
          //add:solve the position correcting after iframe embedded
		  var winleft=  document.getElementById("playWnd").style.left; 
		   var wintop=  document.getElementById("playWnd").style.top; 
		  
		   console.log("win values",wintop,winleft);
          oWebControl.JS_SetDocOffset({
            left:window.savePos ? window.savePos.left : 0,
            top:window.savePos ? window.savePos.top : 0
			
			
			//Try1
		    //left:100,
			//top:100
			
			//Try2
		    //left:winleft,
			//top:wintop
			
						
			//Try3
		    //left:5,
			//top:5
			
				//Try4
		    //left:winleft+10,
			//top:wintop+10
			
			//try5
		//	 left: 0,
          //  top: 0
			
			
			// No changes happend in View, While i changed here 
			
          });
          console.log('调用JS_SetDocOffset接口');

          oWebControl.JS_SetWindowAttr({
            outerWidth: window.saveWindowAttr ? window.saveWindowAttr.outerWidth : 0,
            innerWidth: window.saveWindowAttr ? window.saveWindowAttr.innerWidth : 0,
            outerHeight: window.saveWindowAttr ? window.saveWindowAttr.outerHeight : 0,
            innerHeight: window.saveWindowAttr ? window.saveWindowAttr.innerHeight : 0
          });
          console.log('调用JS_SetWindowAttr接口');

          oWebControl.JS_CreateWnd("playWnd", 600, 400, {
            //add:solve get and modify of title under cross orgin iframe
            cbSetDocTitle: function (uuid) {
              //push message，to modify title of parent window 
       //       var parentDomain = 'http://192.168.1.190:5100/';//ip of parent window
			  //http://192.168.1.190:5100/TrinityLiveStream/try/app.html                 // parent
			  //http://192.168.1.190:5100/TrinityLiveStream/try/index.html                // child
			  
			  
			  
			  	 // href-pathname
			
			
			   console.log( parent.window.location);
             console.log( parent.window.location.href);
             console.log(  parent.window.location.pathname);
             console.log(  parent.window.location.hash );
			 
			 console.log("parent.window");
			 /*
              if(window.parent){
                window.parent.postMessage({
                  action:'changeTitle',
                  msg:'notification',
                  info:uuid
                }, parentDomain);
              }
              */
              
              
              changeTitle(uuid,'notification');
            }
          }).then(function () {
          
            //add:solve getting and modify of title under cross orgin
			
			 oWebControl.JS_SetNumberOfWindows(1); 
			   console.log("JS_CreateWnd success");
//
        //    var parentDomain = 'http://192.168.1.190:5100/';//ip of parent window
     
        /*
        
        if(window.parent){
              window.parent.postMessage({
                action:'changeTitle',
                msg:'notification',
                info:window.saveTitle
              }, parentDomain);
            }
        */
        
        
        changeTitle(window.saveTitle,'notification');
          });
          
          
          

          //get snap dir path
          oWebControl.JS_GetLocalConfig(true).then(
            function(resp){
              $('#snapDir').val(resp.capturePath||'');
            },function(){
              console.log('get snap dir failed.')
            });


        }, function () {
        });
      },
      cbConnectError: function () {
        console.log("cbConnectError");
        oWebControl = null;
        $("#playWnd").html("Plugin not started, trying to start, please wait...");
        WebControl.JS_WakeUp("VideoWebPlugin://");
        initCount++;
        if (initCount < 3) {
          setTimeout(function () {
            initPlugin();
          }, 3000)
        } else {
          $("#playWnd").html("The plugin failed to start. Please check whether the plugin is installed！");
        }
      },
      cbConnectClose: function () {
        console.log("cbConnectClose");
        oWebControl = null;
      }
    });
  }

    
    
  InitialiseReverseMessenger();
  initPlugin();




  // get RSA public key 
  function getPubKey(callback) {
    oWebControl.JS_RequestInterface({
      funcName: "getRSAPubKey",
      argument: JSON.stringify({
        keyLength: 1024
      })
    }).then(function (oData) {
      console.log(oData)
      if (oData.responseMsg.data) {
        pubKey = oData.responseMsg.data || 'test';
        callback()
      }
    })
  }

  // set window control callback
  function setCallbacks() {
    oWebControl.JS_SetWindowControlCallback({
      cbIntegrationCallBack: cbIntegrationCallBack
    });
  }

  // push message
  function cbIntegrationCallBack(oData) {
    showCBInfo(JSON.stringify(oData.responseMsg));
  }

  // RSA encrypt
  function setEncrypt(value) {
    var encrypt = new JSEncrypt();
    encrypt.setPublicKey(pubKey);
    return encrypt.encrypt(value);
  }

  // initial
  $("#init").click(function () {
    getPubKey(function () {
      var appkey = $("#appkey").val();
      var secret = setEncrypt($("#secret").val());
      var ip = $("#ip").val();
      var port = Number.parseInt($("#port").val());
      var snapDir = $("#snapDir").val();
      var layout = $("#layout").val();
      var encryptedFields = ['secret'];
      $(".encryptedFields").each(function (index, item) {
        var $item = $(item);
        if ($item.prop('checked')) {
          var value = $item.val();
          if (value !== 'secret') {
            encryptedFields.push(value);
          }

          // secret encrypt，optional for others
          if (value == 'ip') {
            ip = setEncrypt(ip)
          }
          if (value == 'appkey') {
            appkey = setEncrypt(appkey)
          }
          if (value == 'snapDir') {
            snapDir = setEncrypt(snapDir)
          }
          if (value == 'layout') {
            layout = setEncrypt(layout)
          }
        }
      })
      encryptedFields = encryptedFields.join(",");

      if (!appkey) {
        showCBInfo("appkey can not empty！", 'error');
        return
      }
      if (!$("#secret").val()) {
        showCBInfo("secret can not empty！", 'error');
        return
      }
      if (!ip) {
        showCBInfo("ip can not empty！", 'error');
        return
      }
      if (!$("#port").val()) {
        showCBInfo("port can not empty！", 'error');
        return
      } else if (!/^([0-9]|[1-9]\d{1,3}|[1-5]\d{4}|6[0-5]{2}[0-3][0-5])$/.test($("#port").val())) {
        showCBInfo("Incorrect Port！", 'error');
        return
      }
      console.log({
        appkey: appkey,
        secret: secret,
        ip: ip,
        playMode: 0, // live view
        port: port,
        snapDir: snapDir,
        layout: layout,
        encryptedFields: encryptedFields
      })

      oWebControl.JS_RequestInterface({
        funcName: "init",
        argument: JSON.stringify({
          appkey: appkey,
          secret: secret,
          ip: ip,
          playMode: 0, // live view
          port: port,
          snapDir: snapDir,
          layout: layout,
          encryptedFields: encryptedFields
        })
      }).then(function (oData) {
        //oWebControl.JS_ShowWnd();
        showCBInfo(JSON.stringify(oData ? oData.responseMsg : ''));
      });
    })
  });

  // video live view
  $("#startPreview").click(function () {
    var cameraIndexCode = $("#cameraIndexCode ").val();
    var streamMode = +$("#streamMode").val();
    var transMode = +$("#transMode").val();
    var gpuMode = +$("#gpuMode").val();

    if (!cameraIndexCode) {
      showCBInfo("Camera NO. can not empty！", 'error');
      return
    }

    oWebControl.JS_RequestInterface({
      funcName: "startPreview",
      argument: JSON.stringify({
        cameraIndexCode: cameraIndexCode,
        streamMode: streamMode,
        transMode: transMode,
        gpuMode: gpuMode
      })
    }).then(function (oData) {
      showCBInfo(JSON.stringify(oData ? oData.responseMsg : ''));
    });
  })

  // stop live view
  $("#stopAllPreview").click(function () {
    oWebControl.JS_RequestInterface({
      funcName: "stopAllPreview"
    }).then(function (oData) {
      showCBInfo(JSON.stringify(oData ? oData.responseMsg : ''));
    });
  })

  // uninitial
  function uninit() {
    oWebControl.JS_RequestInterface({
      funcName: "uninit"
    }).then(function (oData) {
      showCBInfo(JSON.stringify(oData ? oData.responseMsg : ''));
    });
  }
  $("#uninit").click(uninit)


  // display call back infomation
  function showCBInfo(szInfo, type) {
    if (type === 'error') {
      szInfo = "<div style='color: red;'>" + dateFormat(new Date(), "yyyy-MM-dd hh:mm:ss") + " " + szInfo + "</div>";
    } else {
      szInfo = "<div>" + dateFormat(new Date(), "yyyy-MM-dd hh:mm:ss") + " " + szInfo + "</div>";
    }
    $("#cbInfo").html(szInfo + $("#cbInfo").html());
  }

  $("#clear").click(function () {
    $("#cbInfo").html('');
  })

  // format time
  function dateFormat(oDate, fmt) {
    var o = {
      "M+": oDate.getMonth() + 1, //月份
      "d+": oDate.getDate(), //日
      "h+": oDate.getHours(), //小时
      "m+": oDate.getMinutes(), //分
      "s+": oDate.getSeconds(), //秒
      "q+": Math.floor((oDate.getMonth() + 3) / 3), //quarter
      "S": oDate.getMilliseconds() //毫秒
    };
    if (/(y+)/.test(fmt)) {
      fmt = fmt.replace(RegExp.$1, (oDate.getFullYear() + "").substr(4 - RegExp.$1.length));
    }
    for (var k in o) {
      if (new RegExp("(" + k + ")").test(fmt)) {
        fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
      }
    }
    return fmt;
  }
</script>

</html>